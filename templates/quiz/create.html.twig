{% extends 'base.html.twig' %}

{% block meta %}
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
{% endblock %}

{% block title %}Create Quiz - Step {{ step }}{% endblock %}

{% block body %}
    <div class="container my-4">
        <h1 class="display-5 text-primary mb-4">Create Quiz - Step {{ step }} of {{ maxSteps }}</h1>

        {{ form_start(form, {'attr': {'class': 'needs-validation', 'novalidate': 'novalidate'}}) }}

        {% if step == 1 %}
            {{ form_row(form.title) }}
            {{ form_row(form.description) }}

        {% elseif step == 2 %}
            <div data-collection-holder="questions"
                 data-index="{{ form.questions|length }}"
                 data-prototype="{{ form_widget(form.questions.vars.prototype)|e('html_attr') }}">
                {% for question in form.questions %}
                    <div class="question-item card mt-3 p-3 border" data-question-index="{{ loop.index0 }}">
                        <h6 class="question-header">Pytanie {{ loop.index }}</h6>
                        {{ form_row(question.content) }}
                        {{ form_row(question.points) }}

                        <div data-collection-holder="answers"
                             data-index="{{ question.answers|length }}"
                             data-prototype="{{ form_widget(question.answers.vars.prototype)|e('html_attr') }}"
                             class="answers-collection">
                            {% for answer in question.answers %}
                                <div class="answer-item card mt-2 p-2 border">
                                    <h6>Odp. {{ loop.index }}</h6>
                                    <div class="row align-items-center">
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                {{ form_widget(answer.isCorrect) }}
                                                {{ form_label(answer.isCorrect) }}
                                            </div>
                                        </div>
                                        <div class="col-md-10">
                                            {{ form_widget(answer.content) }}
                                        </div>
                                    </div>
                                    <button type="button" class="remove-answer btn btn-danger btn-sm mt-2" style="display: {% if loop.index0 > 0 %}inline-block{% else %}none{% endif %};">Remove</button>
                                </div>
                            {% endfor %}
                        </div>

                        <!-- NIE dodajemy przycisku Add Answer w Twig -->
                        <button type="button" class="remove-question btn btn-danger btn-sm mt-2" style="display: {% if loop.index0 > 0 %}inline-block{% else %}none{% endif %};">Remove</button>
                    </div>
                {% endfor %}
            </div>
            <button type="button" class="add-question btn btn-primary mt-3 mb-2">Add Question</button>

        {% elseif step == 3 %}
            {{ form_row(form.timeLimit) }}
            {{ form_row(form.isPublished) }}
        {% endif %}

        <div class="mt-3">
            <button type="submit" class="btn btn-primary">Next</button>
            {% if step > 1 %}
                <a href="{{ path('quiz_create_step', {'step': step - 1}) }}" class="btn btn-secondary">Back</a>
            {% endif %}
            <a href="{{ path('quiz_create_cancel') }}" class="btn btn-danger">Przerwij tworzenie</a>
        </div>

        {{ form_end(form) }}
        <style>
            .question-item {
                background-color: #f8f9fa;
                border-radius: 0.25rem;
                margin-bottom: 1rem;
            }
            .question-header {
                font-weight: bold;
                margin-bottom: 0.5rem;
            }
            .answer-item {
                background-color: #e9ecef;
                border-radius: 0.25rem;
                margin-top: 0.5rem;
                padding: 0.5rem;
            }
            .remove-question, .remove-answer {
                position: absolute;
                top: 10px;
                right: 10px;
            }
        </style>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        function restyleAnswerItem(answerElem) {
            const input = answerElem.querySelector('input[type="text"]');
            const checkbox = answerElem.querySelector('input[type="checkbox"]');
            const label = answerElem.querySelector('label');
            const wrapper = document.createElement('div');
            wrapper.className = 'row align-items-center';
            const colCheckbox = document.createElement('div');
            colCheckbox.className = 'col-md-2';
            const formCheck = document.createElement('div');
            formCheck.className = 'form-check';
            if (checkbox) formCheck.appendChild(checkbox);
            if (label) formCheck.appendChild(label);
            colCheckbox.appendChild(formCheck);
            const colInput = document.createElement('div');
            colInput.className = 'col-md-10';
            if (input) colInput.appendChild(input);
            wrapper.append(colCheckbox, colInput);

            answerElem.innerHTML = '';
            answerElem.appendChild(wrapper);

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-answer btn btn-danger btn-sm mt-2';
            removeBtn.textContent = 'Remove';
            removeBtn.addEventListener('click', () => {
                const parent = answerElem.parentElement;
                answerElem.remove();
                parent.dataset.index = parent.querySelectorAll('.answer-item').length;
                updateAddAnswerVisibility(parent);
            });
            answerElem.appendChild(removeBtn);
        }

        function updateAddAnswerVisibility(container) {
            const count = container.querySelectorAll('.answer-item').length;
            const btn = container.closest('.question-item').querySelector('.add-answer');
            if (btn) btn.style.display = count >= 4 ? 'none' : 'inline-block';
        }

        function bindAnswerCollection(container) {
            container.dataset.index = container.querySelectorAll('.answer-item').length;
            const prototype = container.dataset.prototype;
            const parent = container.closest('.question-item');

            // addâ€‘answer button
            let btn = parent.querySelector('.add-answer');
            if (!btn) {
                btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'add-answer btn btn-secondary mt-2 mb-2';
                btn.textContent = 'Add Answer';
                parent.appendChild(btn);
            }
            btn.addEventListener('click', () => {
                if (container.querySelectorAll('.answer-item').length >= 4) return;
                const idx = parseInt(container.dataset.index);
                const div = document.createElement('div');
                div.className = 'answer-item card mt-2 p-2 border';
                div.innerHTML = prototype.replace(/__answers_name__/g, idx);
                restyleAnswerItem(div);
                container.appendChild(div);
                container.dataset.index = idx + 1;
                updateAddAnswerVisibility(container);
            });

            // bind removal on existing items
            container.querySelectorAll('.answer-item').forEach(restyleAnswerItem);
            updateAddAnswerVisibility(container);
        }

        function bindQuestion(questionElem) {
            const remQ = questionElem.querySelector('.remove-question');
            if (remQ) remQ.addEventListener('click', () => questionElem.remove());
            const collection = questionElem.querySelector('[data-collection-holder="answers"]');
            if (collection) bindAnswerCollection(collection);
        }

        function initAll() {
            document.querySelectorAll('.question-item').forEach(bindQuestion);
            document.querySelectorAll('.answers-collection').forEach(bindAnswerCollection);
        }

        // init on DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            initAll();

            const questionHolder = document.querySelector('[data-collection-holder="questions"]');
            const addQ = document.querySelector('.add-question');
            let qIndex = parseInt(questionHolder.dataset.index);

            addQ.addEventListener('click', () => {
                const protoQ = questionHolder.dataset.prototype;
                const div = document.createElement('div');
                div.className = 'question-item card mt-3 p-3 border';
                div.innerHTML = `<h6 class="question-header">Pytanie ${qIndex+1}</h6>` + protoQ.replace(/__name__/g, qIndex);
                questionHolder.appendChild(div);
                bindQuestion(div);
                questionHolder.dataset.index = ++qIndex;
            });
        });

        // re-init on full load (after twig re-renders reply from server restoring session state)
        window.addEventListener('load', initAll);
    </script>
{% endblock %}