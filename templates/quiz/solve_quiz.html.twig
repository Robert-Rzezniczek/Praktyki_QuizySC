{% extends 'base.html.twig' %}

{% block meta %}
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
{% endblock %}

{% block title %}
    {{ 'title.solve_quiz'|trans }} {{ quiz.title }}
{% endblock %}

{% block body %}
    <h1>{{ 'title.solve_quiz'|trans }} {{ quiz.title }}</h1>

    {% if app.flashes('error') is not empty %}
        <div class="alert alert-danger">
            {% for message in app.flashes('error') %}
                {{ message|trans }}
            {% endfor %}
        </div>
    {% endif %}

    {% if question %}
        <div class="quiz-question">
            <h2>{{ question.content }}</h2>
            <div id="timer" class="alert alert-info">Pozostały czas: <span id="time-remaining">00:00</span></div>
            {{ form_start(form, {'attr': {'id': 'quiz-solve-form'}}) }}
            {{ form_widget(form.answer) }}
            {{ form_widget(form.question_index) }}
            <button type="submit" class="btn btn-primary">
                {% if is_last_question %}
                    {{ 'action.finish'|trans }}
                {% else %}
                    {{ 'action.next'|trans }}
                {% endif %}
            </button>
            {{ form_end(form) }}
        </div>
    {% else %}
        <p>{{ 'message.quiz_completed'|trans }}</p>
        <a href="{{ path('quiz_index') }}" class="btn btn-secondary">{{ 'action.back_to_list'|trans }}</a>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const quizId = {{ quiz.id }};
            const startedAt = {{ started_at|default(0) }};
            const timeLimit = {{ time_limit }} * 60; // Konwersja minut na sekundy
            const checkStatusUrl = '{{ path('quiz_check_status', {'id': quiz.id}) }}';
            const timerElement = document.getElementById('time-remaining');
            const form = document.getElementById('quiz-solve-form');
            const questionIndexInput = form.querySelector('input[name="quiz_solve[question_index]"]');
            let timeRemaining = timeLimit - (Date.now() / 1000 - startedAt);
            let quizEnded = false;

            function updateTimer() {
                if (quizEnded || timeRemaining <= 0) {
                    if (!quizEnded) {
                        endQuizDueToTime();
                    }
                    return;
                }
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = Math.floor(timeRemaining % 60);
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                timeRemaining--;
            }

            function endQuizDueToTime() {
                if (quizEnded) return;
                quizEnded = true;
                alert('{{ 'message.time_limit_exceeded'|trans }}');
                submitFormAndFinalize();
            }

            function submitFormAndFinalize() {
                fetch('{{ path('quiz_solve', {'id': quiz.id}) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: new URLSearchParams({
                        'quiz_solve[question_index]': questionIndexInput.value,
                        '_token': '{{ csrf_token('quiz_solve_' ~ quiz.id) }}'
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = '{{ path('quiz_index') }}';
                        } else if (data.error) {
                            alert(data.error);
                            window.location.href = '{{ path('quiz_index') }}';
                        }
                    })
                    .catch(error => {
                        console.error('Error ending quiz:', error);
                        window.location.href = '{{ path('quiz_index') }}';
                    });
            }

            // Aktualizuj timer co sekundę
            const timerInterval = setInterval(updateTimer, 1000);
            updateTimer();

            // Sprawdzaj status quizu co 10 sekund
            const statusInterval = setInterval(() => {
                fetch(checkStatusUrl, {
                    method: 'GET',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.isPublished) {
                            clearInterval(timerInterval);
                            clearInterval(statusInterval);
                            alert('{{ 'message.quiz_expired'|trans }}');
                            submitFormAndFinalize();
                        }
                    })
                    .catch(error => console.error('Error checking status:', error));
            }, 10000);

            // Zatrzymaj timer i sprawdzanie statusu, jeśli quiz się zakończy
            form.addEventListener('submit', () => {
                clearInterval(timerInterval);
                clearInterval(statusInterval);
            });

            // Blokada cofania
            window.onpopstate = function(event) {
                if (event.state) {
                    window.location.href = '{{ path('quiz_index') }}';
                }
            };
            history.pushState(null, document.title, window.location.href);
        });
    </script>
{% endblock %}